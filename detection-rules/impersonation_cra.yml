name: "Brand impersonation: Canada Revenue Agency"
description: "Impersonation of the Canada Revenue Agency, Canada's federal tax authority."
type: "rule"
severity: "high"
source: |
  type.inbound
  and (
    (
      strings.ilike(sender.display_name, '*canada revenue agency*')
      or regex.icontains(sender.display_name, '\bcra\b')
      or strings.ilevenshtein(sender.display_name, 'canada revenue agency') <= 2
      or regex.icontains(sender.email.domain.domain, '\bcra\b')
    )
    or (
      (
        strings.ilike(subject.subject, '*canada revenue agency*')
        or regex.icontains(subject.subject, '\bcra\b')
      )
      and (
        any(ml.nlu_classifier(body.current_thread.text).entities,
            .name == "org" and .text in~ ("cra", "canada revenue agency")
        )
        or strings.ilike(body.current_thread.text,
                         '*cra*',
                         '*canada revenue agency*'
        )
      )
    )
  )
  and (
    (
      any(ml.nlu_classifier(body.current_thread.text).intents,
          .name in ("cred_theft", "callback_scam", "steal_pii", "bec")
      )
      and any(ml.nlu_classifier(body.current_thread.text).entities,
              .name in ("urgency", "financial", "request")
      )
    )
    or (
      any(attachments,
          (
            (.file_type in ("html") or .file_extension in ("htm", "html"))
            and (
              any(ml.nlu_classifier(file.parse_html(.).display_text).intents,
                  .name in ("cred_theft", "callback_scam", "steal_pii", "bec")
              )
              and any(ml.nlu_classifier(file.parse_html(.).display_text).entities,
                      .name in ("urgency", "financial", "request")
              )
            )
          )
          or (
            (.file_type in ("pdf") or .file_extension in ("pdf"))
            and any(file.explode(.),
                    (
                      any(ml.nlu_classifier(.scan.ocr.raw).intents,
                          .name in (
                            "cred_theft",
                            "callback_scam",
                            "steal_pii",
                            "bec"
                          )
                      )
                      and any(ml.nlu_classifier(.scan.ocr.raw).entities,
                              .name in ("urgency", "financial", "request")
                      )
                    )
            )
          )
      )
    )
  )
  and sender.email.domain.root_domain not in~ ('canada.ca')
  and sender.email.email not in $recipient_emails

attack_types:
  - "BEC/Fraud"
  - "Credential Phishing"
tactics_and_techniques:
  - "Evasion"
  - "HTML smuggling"
  - "Image as content"
  - "Impersonation: Brand"
  - "Scripting"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "File analysis"
  - "Natural Language Understanding"
  - "Optical Character Recognition"
  - "Sender analysis"
id: "d2a3c6a9-c2a5-596b-8e22-ffeaa2e69a95"
tags:
  - pr_author_aidenmitchell