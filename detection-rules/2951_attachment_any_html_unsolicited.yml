name: "PR# 2951 - Attachment: Any HTML file (unsolicited)"
description: |
  Potential HTML smuggling attacks in unsolicited messages.
  Use if passing HTML files is not normal behavior in your environment.
  This rule may be expanded to inspect HTML attachments for suspicious code.
references:
  - "https://ired.team/offensive-security/defense-evasion/file-smuggling-with-html-and-javascript"
  - "https://sandbox.sublimesecurity.com?id=106315e9-166a-4e0f-946e-88ff6fd5f9fd"
  - https://github.com/sublime-security/sublime-rules/pull/2951
type: "rule"
severity: "low"
source: |
  type.inbound
  and any(attachments, .file_extension in~ ('htm', 'html') or .file_type == "html")
  and (
    not profile.by_sender().solicited
    or profile.by_sender().any_messages_malicious_or_spam
  )

  and not profile.by_sender().any_messages_benign

  // negate highly trusted sender domains unless they fail DMARC authentication
  and (
    (
      sender.email.domain.root_domain in $high_trust_sender_root_domains
      and not headers.auth_summary.dmarc.pass
    )
    or sender.email.domain.root_domain not in $high_trust_sender_root_domains
  )
  
tags:
  - "Attack surface reduction"
  - pr_author_IndiaAce
  - created_from_open_prs
  - rule_status_modified
tactics_and_techniques:
  - "HTML smuggling"
detection_methods:
  - "File analysis"
  - "HTML analysis"
  - "Sender analysis"
id: "788f9802-41fd-5758-a1ca-691b4044ee50"
