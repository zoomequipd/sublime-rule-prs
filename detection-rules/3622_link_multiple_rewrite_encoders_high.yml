name: "PR# 3622 - Link: Excessive URL rewrite encoders"
description: "Detects URLs with many (excessive) encoding patterns, including multiple instances of the same encoder or four or more distinct encoders. These techniques are commonly used to obfuscate malicious URLs and evade security filters."
type: "rule"
severity: "high"
source: |
  type.inbound
  and (
    any(body.current_thread.links,
        (
          // 4 or more encoders but they are all distinct
          length(.href_url.rewrite.encoders) >= 4
          and length(distinct(.href_url.rewrite.encoders)) >= 4
        )
    )
    or any(attachments,
           any(file.explode(.),
               any(.scan.url.urls,
                   (
                     // 4 or more encoders but they are all distinct
                     length(.rewrite.encoders) >= 4
                     and length(distinct(.rewrite.encoders)) >= 4
                   )
               )
           )
    )
  )
tags:
  - "Attack surface reduction"
  - pr_author_MSAdministrator
  - created_from_open_prs
  - rule_status_added
attack_types:
  - "Credential Phishing"
  - "Malware/Ransomware"
tactics_and_techniques:
  - "Encryption"
  - "Evasion"
detection_methods:
  - "URL analysis"
  - "Content analysis"
  - "Archive analysis"
  - "File analysis"
id: "4cbb2de6-ba75-5a24-8bc0-bfaf0c6925d2"
references:
  - https://github.com/sublime-security/sublime-rules/pull/3622