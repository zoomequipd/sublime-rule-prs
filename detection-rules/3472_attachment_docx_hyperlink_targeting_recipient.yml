name: "PR# 3472 - Attachment: DOCX with hyperlink targeting recipient address"
description: "Detects DOCX attachments containing hyperlinks with anchor references that match recipient email addresses. This technique is commonly used to personalize malicious documents and evade detection."
type: "rule"
severity: "medium"
source: |
  type.inbound
  and any(filter(attachments, .file_extension in ('docx', 'docm')),
          any(filter(file.explode(.),
                     strings.icontains(.scan.strings.raw, '<w:hyperlink')
              ),
              any(regex.iextract(.scan.strings.raw,
                                 '<w:hyperlink[^\>]*w:anchor="(?P<email_address>[^\"]+)"'
                  ),
                  .named_groups["email_address"] == recipients.to[0].email.email
                  or any(strings.scan_base64(.named_groups["email_address"],
                                             ignore_padding=true
                         ),
                         strings.icontains(., recipients.to[0].email.email)
                  )
              )
          )
  )
attack_types:
  - "Credential Phishing"
  - "Malware/Ransomware"
tactics_and_techniques:
  - "Evasion"
  - "Social engineering"
detection_methods:
  - "File analysis"
  - "Archive analysis"
  - "XML analysis"
id: "d2ff2c1e-2994-5ca2-8bf3-508213e11364"
tags:
  - created_from_open_prs
  - rule_status_added
  - pr_author_D-Bolton
references:
  - https://github.com/sublime-security/sublime-rules/pull/3472