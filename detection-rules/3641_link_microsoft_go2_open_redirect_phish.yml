name: "PR# 3641 - Open redirect (go2.aspx) leading to Microsoft credential phishing"
description: |
  This rule is designed to detect credential phishing attacks that exploit go2.aspx redirects and masquerade as
  Microsoft-related emails.
type: "rule"
severity: "medium"
source: |
  type.inbound

  // url path ends with go2.aspx
  and any(body.links,
          strings.ends_with(.href_url.path, "go2.aspx")

          // query params from href_url or ml.link_analysis contain a redirection string ending with a base64
          // pattern intended to capture an encoded email passed as an additional parameter
          and (
            regex.contains(.href_url.query_params,
                           '[a-z]=[a-z0-9-]+\.[a-z]{2,3}.+[A-Za-z0-9+/=]$|=[^=]$|={3,}$'
            )
            or regex.icontains(ml.link_analysis(.).effective_url.query_params,
                               '[a-z]=[a-z0-9-]+\.[a-z]{2,3}.+[A-Za-z0-9+/=]$|=[^=]$|={3,}$'
            )
          )
  )
  and headers.mailer is null
  and regex.icontains(body.html.inner_text, '(i\x{034F}c\x{034F}r\x{034F}os\x{034F}of\x{034F}|icrosof)|(office|o)\s?365')
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Impersonation: Brand"
  - "Open redirect"
detection_methods:
  - "Content analysis"
  - "Header analysis"
  - "URL analysis"
id: "a65fab43-63c8-534d-96e1-f7378e22c4e5"
tags:
  - created_from_open_prs
  - rule_status_modified
  - pr_author_aidenmitchell
references:
  - https://github.com/sublime-security/sublime-rules/pull/3641